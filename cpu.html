<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPU æ ¸å¿ƒåŸç†äº¤äº’å¼æ•™å­¦å®éªŒå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom Neon & Glassmorphism Styles */
        :root {
            --neon-cyan: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-orange: #ff9e00;
            --neon-green: #0aff0a;
            --bg-dark: #050b14;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--bg-dark);
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
        }

        /* Background Animation */
        .bg-grid {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
            pointer-events: none;
        }

        /* Glassmorphism Card */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Neon Text & Borders */
        .text-neon-cyan { color: var(--neon-cyan); text-shadow: 0 0 8px var(--neon-cyan); }
        .text-neon-purple { color: var(--neon-purple); text-shadow: 0 0 8px var(--neon-purple); }
        .border-neon-cyan { border-color: var(--neon-cyan); box-shadow: 0 0 8px var(--neon-cyan); }
        
        /* Navigation */
        .nav-item {
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .nav-item::after {
            content: '';
            position: absolute;
            bottom: -4px; left: 0; width: 0%; height: 2px;
            background: var(--neon-cyan);
            box-shadow: 0 0 8px var(--neon-cyan);
            transition: width 0.3s;
        }
        .nav-item.active::after { width: 100%; }
        .nav-item:hover { color: var(--neon-cyan); }

        /* LED Font for numbers */
        @font-face {
            font-family: 'Digital';
            src: url('https://fonts.cdnfonts.com/s/14892/Digital7Mono-B1g5.woff') format('woff'); /* Fallback or use a google font if available, using system mono for now if fails */
        }
        .font-led {
            font-family: 'Courier New', Courier, monospace; /* Fallback */
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #020408; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px var(--neon-cyan); }
            50% { box-shadow: 0 0 20px var(--neon-cyan), 0 0 10px var(--neon-purple); }
        }
        .animate-pulse-glow { animation: pulse-glow 2s infinite; }

        /* PAGE 3: PERFORMANCE */
        #page-performance {
            overflow-y: auto; /* Ensure scrolling on mobile */
            flex-direction: column; /* Stack vertically on mobile */
        }
        @media (min-width: 768px) {
            #page-performance {
                flex-direction: row; /* Side by side on desktop */
                overflow-y: hidden; /* No scroll if fits */
            }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Background -->
    <div class="bg-grid"></div>

    <!-- Navigation -->
    <nav class="glass-card z-50 px-4 py-3 flex flex-col md:flex-row justify-between items-center sticky top-0 bg-black/40 backdrop-blur-md border-b border-white/10 gap-4">
        <div class="flex items-center gap-3 w-full md:w-auto justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-blue-600 rounded-lg shadow-lg shadow-cyan-500/20 flex items-center justify-center font-bold text-black text-lg">CPU</div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold tracking-wider text-white leading-tight">ç¡¬ä»¶å®éªŒå®¤</h1>
                    <span class="text-xs text-cyan-400 font-normal">Interactive Learning Kit</span>
                </div>
            </div>
            <!-- Mobile Menu Toggle (Hidden on Desktop) -->
            <button class="md:hidden text-white border border-white/20 px-3 py-1 rounded" onclick="document.getElementById('nav-menu').classList.toggle('hidden')">
                â˜°
            </button>
        </div>
        
        <div id="nav-menu" class="hidden md:flex flex-col md:flex-row gap-2 md:gap-4 text-sm font-bold w-full md:w-auto">
            <button onclick="switchTab('structure')" id="nav-structure" class="nav-btn px-4 py-2 rounded-full border border-cyan-500/30 text-cyan-400 hover:bg-cyan-500/10 transition-all shadow-[0_0_10px_rgba(6,182,212,0.1)] active-tab text-center">
                ğŸ—ï¸ ç»“æ„
            </button>
            <button onclick="switchTab('pipeline')" id="nav-pipeline" class="nav-btn px-4 py-2 rounded-full border border-purple-500/30 text-purple-400 hover:bg-purple-500/10 transition-all shadow-[0_0_10px_rgba(168,85,247,0.1)] text-center">
                ğŸš€ æµæ°´çº¿
            </button>
            <button onclick="switchTab('performance')" id="nav-performance" class="nav-btn px-4 py-2 rounded-full border border-orange-500/30 text-orange-400 hover:bg-orange-500/10 transition-all shadow-[0_0_10px_rgba(249,115,22,0.1)] text-center">
                âš¡ æ€§èƒ½
            </button>
            <a href="index.html" class="px-4 py-2 rounded-full border border-green-500/30 text-green-400 hover:bg-green-500/10 transition-all shadow-[0_0_10px_rgba(34,197,94,0.1)] text-center no-underline">
                ğŸ’¾ å»å­¦å†…å­˜
            </a>
             <a href="kejian.html" class="px-4 py-2 rounded-full border border-rose-500/30 text-rose-400 hover:bg-rose-500/10 transition-all shadow-[0_0_10px_rgba(244,63,94,0.1)] text-center no-underline">
        ğŸ“Š è¯¾ä»¶
    </a>
        </div>
    </nav>

    <style>
        .nav-btn.active-tab {
            background: rgba(255,255,255,0.1);
            box-shadow: inset 0 0 20px rgba(255,255,255,0.05);
            border-width: 2px;
        }
        #nav-structure.active-tab { border-color: var(--neon-cyan); color: #fff; background: rgba(6,182,212,0.2); box-shadow: 0 0 15px var(--neon-cyan); }
        #nav-pipeline.active-tab { border-color: var(--neon-purple); color: #fff; background: rgba(168,85,247,0.2); box-shadow: 0 0 15px var(--neon-purple); }
        #nav-performance.active-tab { border-color: var(--neon-orange); color: #fff; background: rgba(249,115,22,0.2); box-shadow: 0 0 15px var(--neon-orange); }
    </style>

    <!-- Main Content Area -->
    <main class="flex-1 relative overflow-hidden">
        
        <!-- PAGE 1: STRUCTURE (3D) -->
        <section id="page-structure" class="absolute inset-0 flex flex-col transition-opacity duration-500 opacity-100 z-10">
            <div class="absolute top-4 left-4 z-20">
                <button onclick="toggleDataFlow()" class="glass-card px-4 py-2 rounded text-cyan-400 hover:bg-white/10 transition flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span> æ’­æ”¾æ•°æ®æµ
                </button>
            </div>
            
            <!-- 3D Container -->
            <div id="canvas-container" class="w-full h-full"></div>

            <!-- Info Overlay (Right) -->
            <div id="info-card" class="absolute top-20 right-8 w-80 glass-card p-6 rounded-xl transform translate-x-full transition-transform duration-300 border-l-4 border-cyan-400">
                <h3 id="info-title" class="text-xl font-bold text-white mb-2">éƒ¨ä»¶åç§°</h3>
                <p id="info-desc" class="text-gray-300 text-sm leading-relaxed mb-4">éƒ¨ä»¶æè¿°...</p>
                <div class="text-xs text-cyan-300 bg-cyan-900/30 p-2 rounded">
                    <span class="font-bold">ğŸ’¡ é€šä¿—ç±»æ¯”ï¼š</span> <span id="info-analogy">...</span>
                </div>
                <button onclick="closeInfo()" class="absolute top-2 right-2 text-gray-500 hover:text-white">Ã—</button>
            </div>

            <!-- Quiz Overlay (Bottom) -->
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 glass-card px-8 py-4 rounded-full flex items-center gap-4">
                <span class="text-cyan-400 font-bold">ä»»åŠ¡ï¼š</span>
                <span id="quiz-text" class="text-white">è¯·ç‚¹å‡»è´Ÿè´£â€œç®—æœ¯ä¸é€»è¾‘è¿ç®—â€çš„éƒ¨ä»¶</span>
                <div id="quiz-feedback" class="hidden px-3 py-1 rounded text-xs font-bold"></div>
            </div>
        </section>

        <!-- PAGE 2: PIPELINE -->
        <section id="page-pipeline" class="absolute inset-0 flex flex-col p-8 transition-opacity duration-500 opacity-0 pointer-events-none z-0">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-white mb-2">æŒ‡ä»¤æµæ°´çº¿ <span class="text-neon-purple">Pipeline</span></h2>
                    <p class="text-gray-400 text-sm">è§‚å¯ŸæŒ‡ä»¤å¦‚ä½•åˆ†é˜¶æ®µå¹¶è¡Œæ‰§è¡Œ</p>
                </div>
                <div class="flex gap-4">
                    <div class="glass-card px-4 py-2 rounded flex items-center gap-2">
                        <span class="text-sm text-gray-400">æ¨¡å¼ï¼š</span>
                        <button id="btn-no-pipe" onclick="setPipelineMode(false)" class="px-3 py-1 rounded bg-gray-700 text-xs hover:bg-gray-600 transition">å•æŒ‡ä»¤ä¸²è¡Œ</button>
                        <button id="btn-pipe" onclick="setPipelineMode(true)" class="px-3 py-1 rounded bg-cyan-600 text-white text-xs shadow-[0_0_10px_rgba(8,145,178,0.5)]">æµæ°´çº¿å¹¶è¡Œ</button>
                    </div>
                    <div class="glass-card px-4 py-2 rounded flex items-center gap-2">
                        <button onclick="pipeStep()" class="w-8 h-8 rounded-full border border-gray-500 flex items-center justify-center hover:bg-white/10">â¯</button>
                        <button onclick="pipePlay()" class="w-8 h-8 rounded-full bg-cyan-600 flex items-center justify-center hover:bg-cyan-500">â–¶</button>
                        <button onclick="pipeReset()" class="w-8 h-8 rounded-full border border-red-500 text-red-400 flex items-center justify-center hover:bg-red-900/30">â†º</button>
                    </div>
                </div>
            </div>

            <!-- Pipeline Visualizer -->
            <div class="flex-1 glass-card rounded-xl p-6 relative overflow-hidden flex flex-col gap-4">
                <!-- Header -->
                <div class="grid grid-cols-6 gap-4 text-center text-gray-500 text-sm font-bold uppercase tracking-widest mb-2">
                    <div class="col-span-1">æŒ‡ä»¤ ID</div>
                    <div class="col-span-1 text-blue-400">å–æŒ‡ (IF)</div>
                    <div class="col-span-1 text-green-400">è¯‘ç  (ID)</div>
                    <div class="col-span-1 text-yellow-400">æ‰§è¡Œ (EX)</div>
                    <div class="col-span-1 text-red-400">å†™å› (WB)</div>
                    <div class="col-span-1">çŠ¶æ€</div>
                </div>
                
                <!-- Tracks -->
                <div id="pipeline-tracks" class="flex-1 flex flex-col gap-3 overflow-y-auto">
                    <!-- Dynamic Rows Here -->
                </div>
            </div>

            <!-- Stats -->
            <div class="h-24 mt-6 grid grid-cols-3 gap-6">
                <div class="glass-card rounded-lg p-4 flex flex-col justify-center items-center">
                    <span class="text-gray-400 text-xs uppercase">å½“å‰å‘¨æœŸ (Cycle)</span>
                    <span id="stat-cycle" class="text-3xl font-led text-white">0</span>
                </div>
                <div class="glass-card rounded-lg p-4 flex flex-col justify-center items-center">
                    <span class="text-gray-400 text-xs uppercase">å®ŒæˆæŒ‡ä»¤æ•°</span>
                    <span id="stat-completed" class="text-3xl font-led text-cyan-400">0</span>
                </div>
                <div class="glass-card rounded-lg p-4 flex flex-col justify-center items-center">
                    <span class="text-gray-400 text-xs uppercase">æµæ°´çº¿æ•ˆç‡ (IPC)</span>
                    <span id="stat-ipc" class="text-3xl font-led text-purple-400">0.00</span>
                </div>
            </div>
        </section>

        <!-- PAGE 3: PERFORMANCE -->
        <section id="page-performance" class="absolute inset-0 flex gap-4 p-4 transition-opacity duration-500 opacity-0 pointer-events-none z-0">
            <!-- Controls (Left) -->
            <div class="w-full md:w-1/3 min-w-0 md:min-w-[300px] flex flex-col gap-4 shrink-0">
                <div class="glass-card p-5 rounded-xl">
                    <h2 class="text-lg font-bold text-white mb-4 border-b border-gray-700 pb-2">å‚æ•°è°ƒèŠ‚</h2>
                    
                    <!-- Frequency -->
                    <div class="mb-6">
                        <div class="flex justify-between mb-2">
                            <label class="text-cyan-400 font-bold">ä¸»é¢‘ (Frequency)</label>
                            <span class="font-led text-white"><span id="val-freq">3.0</span> GHz</span>
                        </div>
                        <input type="range" id="input-freq" min="1.0" max="5.0" step="0.1" value="3.0" oninput="updatePerfParams()">
                        <p class="text-xs text-gray-500 mt-1">å†³å®šCPUæ¯ç§’é’Ÿèƒ½æ•²å¤šå°‘æ¬¡é’Ÿï¼Œè¶Šå¿«å¤„ç†è¶Šå¿«ã€‚</p>
                    </div>

                    <!-- Cores -->
                    <div class="mb-6">
                        <div class="flex justify-between mb-2">
                            <label class="text-purple-400 font-bold">æ ¸å¿ƒæ•° (Cores)</label>
                            <span class="font-led text-white"><span id="val-cores">4</span> æ ¸</span>
                        </div>
                        <input type="range" id="input-cores" min="1" max="8" step="1" value="4" oninput="updatePerfParams()">
                        <div id="core-visuals" class="flex gap-1 mt-2 h-4">
                            <!-- Dynamic Cores -->
                        </div>
                        <p class="text-xs text-gray-500 mt-1">å†³å®šæœ‰å¤šå°‘ä¸ªâ€œå·¥äººâ€åŒæ—¶å¹²æ´»ã€‚</p>
                    </div>

                    <!-- Cache -->
                    <div class="mb-6">
                        <div class="flex justify-between mb-2">
                            <label class="text-orange-400 font-bold">L3 ç¼“å­˜ (Cache)</label>
                            <span class="font-led text-white"><span id="val-cache">16</span> MB</span>
                        </div>
                        <input type="range" id="input-cache" min="2" max="64" step="2" value="16" oninput="updatePerfParams()">
                        <div id="cache-visual" class="w-full h-2 bg-gray-700 mt-2 rounded overflow-hidden">
                            <div id="cache-bar" class="h-full bg-orange-500 w-1/4 transition-all duration-300"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-xl flex-1 flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-4">ä»»åŠ¡æ¨¡æ‹Ÿ</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <button onclick="runPerfTest('gaming')" class="p-3 rounded border border-gray-700 hover:border-cyan-400 hover:bg-cyan-900/20 transition text-left group">
                            <div class="font-bold text-gray-200 group-hover:text-cyan-300">ğŸ® å¤§å‹æ¸¸æˆ / 3Dæ¸²æŸ“</div>
                            <div class="text-xs text-gray-500">å¯¹ä¸»é¢‘å’Œæ˜¾å¡ä¾èµ–æé«˜</div>
                        </button>
                        <button onclick="runPerfTest('zip')" class="p-3 rounded border border-gray-700 hover:border-purple-400 hover:bg-purple-900/20 transition text-left group">
                            <div class="font-bold text-gray-200 group-hover:text-purple-300">ğŸ“¦ æ–‡ä»¶è§£å‹ / ç¼–è¯‘</div>
                            <div class="text-xs text-gray-500">å¯¹æ ¸å¿ƒæ•°å’Œç¼“å­˜æ•æ„Ÿ</div>
                        </button>
                        <button onclick="runPerfTest('calc')" class="p-3 rounded border border-gray-700 hover:border-orange-400 hover:bg-orange-900/20 transition text-left group">
                            <div class="font-bold text-gray-200 group-hover:text-orange-300">ğŸ”¢ ç§‘å­¦è®¡ç®— (PI)</div>
                            <div class="text-xs text-gray-500">çº¯ç²¹çš„ç®—åŠ›è€ƒéªŒ</div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts (Right) -->
            <div class="flex-1 flex flex-col gap-6">
                <div class="glass-card p-6 rounded-xl flex-1 relative">
                    <h3 class="text-lg font-bold text-white mb-4">æ€§èƒ½æµ‹è¯•ç»“æœ</h3>
                    <canvas id="perfChart"></canvas>
                    <div id="perf-loading" class="absolute inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden rounded-xl">
                        <div class="text-cyan-400 font-bold animate-pulse text-xl">æ­£åœ¨åŸºå‡†æµ‹è¯•...</div>
                    </div>
                </div>
                
                <!-- Inquiry -->
                <div class="glass-card p-4 rounded-xl">
                    <h4 class="text-sm font-bold text-gray-400 mb-2">ğŸ¤” æ€è€ƒé¢˜ (ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ)</h4>
                    <div class="flex gap-4">
                        <div onclick="this.querySelector('p').classList.toggle('hidden')" class="flex-1 bg-white/5 p-3 rounded cursor-pointer hover:bg-white/10 transition">
                            <div class="text-cyan-300 text-sm font-bold mb-1">Q: æ ¸å¿ƒæ•°è¶Šå¤šè¶Šå¥½å—ï¼Ÿ</div>
                            <p class="hidden text-xs text-gray-300 mt-1">A: ä¸ä¸€å®šã€‚å¦‚æœè½¯ä»¶ä¸æ”¯æŒå¤šæ ¸å¹¶è¡Œï¼ˆå¦‚å¾ˆå¤šè€æ¸¸æˆï¼‰ï¼Œæ ¸å¿ƒå†å¤šä¹Ÿåªèƒ½â€œä¸€æ ¸æœ‰éš¾ï¼Œå…«æ ¸å›´è§‚â€ã€‚</p>
                        </div>
                        <div onclick="this.querySelector('p').classList.toggle('hidden')" class="flex-1 bg-white/5 p-3 rounded cursor-pointer hover:bg-white/10 transition">
                            <div class="text-purple-300 text-sm font-bold mb-1">Q: ä¸ºä»€ä¹ˆç¼“å­˜è¿™ä¹ˆå°ï¼Ÿ</div>
                            <p class="hidden text-xs text-gray-300 mt-1">A: ç¼“å­˜é‡‡ç”¨SRAMï¼Œé€Ÿåº¦æå¿«ä½†é€ ä»·æ˜‚è´µä¸”ä½“ç§¯å¤§ï¼Œåªèƒ½åšå¾—å¾ˆå°ï¼Œå­˜æœ€å¸¸ç”¨çš„æ•°æ®ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Audio Context for Sound Effects -->
    <script>
        // --- AUDIO SYSTEM ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            if (type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'success') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, now);
                osc.frequency.setValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'hover') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(200, now);
                gain.gain.setValueAtTime(0.02, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            }
        }

        // --- NAVIGATION ---
        function switchTab(tabId) {
            playSound('click');
            // Update Nav Buttons
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active-tab'));
            document.getElementById('nav-' + tabId).classList.add('active-tab');

            // Update Pages
            ['structure', 'pipeline', 'performance'].forEach(id => {
                const el = document.getElementById('page-' + id);
                if (id === tabId) {
                    el.classList.remove('opacity-0', 'pointer-events-none', 'z-0');
                    el.classList.add('opacity-100', 'z-10');
                } else {
                    el.classList.add('opacity-0', 'pointer-events-none', 'z-0');
                    el.classList.remove('opacity-100', 'z-10');
                }
            });
        }

        // --- PAGE 1: 3D STRUCTURE (Three.js) ---
        let scene, camera, renderer, raycaster, mouse;
        let cpuGroup, particles = [];
        let isFlowing = false;

        function init3D() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            // Fog for depth
            scene.fog = new THREE.FogExp2(0x050b14, 0.02);

            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 15, 20);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0x00f3ff, 1, 50);
            pointLight.position.set(5, 10, 5);
            scene.add(pointLight);
            const pointLight2 = new THREE.PointLight(0xbc13fe, 1, 50);
            pointLight2.position.set(-5, 5, -5);
            scene.add(pointLight2);

            // CPU Base (PCB)
            const pcbGeo = new THREE.BoxGeometry(14, 0.5, 14);
            const pcbMat = new THREE.MeshPhongMaterial({ color: 0x0a1a2f, specular: 0x111111, shininess: 30 });
            const pcb = new THREE.Mesh(pcbGeo, pcbMat);
            scene.add(pcb);

            // Components Group
            cpuGroup = new THREE.Group();
            scene.add(cpuGroup);

            // Helper to create component
            function createComponent(name, color, x, z, w, d, label, desc, analogy) {
                const geo = new THREE.BoxGeometry(w, 1.5, d);
                const mat = new THREE.MeshPhongMaterial({ 
                    color: color, 
                    transparent: true, 
                    opacity: 0.9,
                    emissive: color,
                    emissiveIntensity: 0.2
                });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(x, 1, z);
                mesh.userData = { name, desc, analogy, originalColor: color };
                
                // Edge glow
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.3 }));
                mesh.add(line);

                cpuGroup.add(mesh);
                return mesh;
            }

            // Create Parts
            createComponent('æ§åˆ¶å™¨ (CU)', 0xff9e00, -3, -3, 4, 4, 'CU', 'æŒ‡æŒ¥ä¸­å¿ƒï¼Œè´Ÿè´£è§£ç æŒ‡ä»¤å¹¶æ§åˆ¶å…¶ä»–éƒ¨ä»¶ã€‚', 'äº¤é€šæŒ‡æŒ¥å®˜ï¼Œå‘Šè¯‰å¤§å®¶è¯¥å¾€å“ªèµ°ã€‚');
            createComponent('è¿ç®—å™¨ (ALU)', 0x0aff0a, 3, -3, 4, 4, 'ALU', 'ç®—æœ¯é€»è¾‘å•å…ƒï¼Œè´Ÿè´£åŠ å‡ä¹˜é™¤å’Œé€»è¾‘åˆ¤æ–­ã€‚', 'æ•°å­¦å¤©æ‰ï¼Œä¸“é—¨è´Ÿè´£ç®—æ•°çš„è®¡ç®—å™¨ã€‚');
            createComponent('ç¼“å­˜ (Cache)', 0xbc13fe, 0, 3, 10, 3, 'Cache', 'é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨ï¼Œå­˜æ”¾CPUæœ€å¸¸ç”¨çš„æ•°æ®ã€‚', 'ä¹¦æ¡Œä¸Šçš„ä¾¿ç­¾çº¸ï¼Œæ¯”å»å›¾ä¹¦é¦†(å†…å­˜)æ‹¿ä¹¦å¿«å¾—å¤šã€‚');
            createComponent('æ ¸å¿ƒ (Core)', 0x00f3ff, 0, 0, 2, 2, 'Core', 'CPUçš„å¤§è„‘æ ¸å¿ƒåŒºåŸŸã€‚', 'çœŸæ­£å¹²æ´»çš„å¤§è„‘ã€‚');

            // Add Labels
            function addLabel(text, x, y, z) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 256; canvas.height = 64;
                ctx.font = "Bold 32px Arial";
                ctx.fillStyle = "rgba(0,0,0,0.5)";
                ctx.roundRect(0, 0, 256, 64, 10);
                ctx.fill();
                ctx.strokeStyle = "rgba(255,255,255,0.5)";
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(text, 128, 32);
                
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMat = new THREE.SpriteMaterial({ map: texture, transparent: true });
                const sprite = new THREE.Sprite(spriteMat);
                sprite.position.set(x, y, z);
                sprite.scale.set(4, 1, 1);
                cpuGroup.add(sprite);
            }

            addLabel("æ§åˆ¶å™¨ CU", -3, 2.5, -3);
            addLabel("è¿ç®—å™¨ ALU", 3, 2.5, -3);
            addLabel("L1 ç¼“å­˜", 0, 3.5, 3);
            addLabel("æ ¸å¿ƒ Core", 0, 2.5, 0);

            // Bus Lines (Visual)
            const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.2, transparent: true });
            const points = [];
            points.push(new THREE.Vector3(-3, 0.5, -3)); points.push(new THREE.Vector3(3, 0.5, -3)); // CU -> ALU
            points.push(new THREE.Vector3(0, 0.5, 0)); points.push(new THREE.Vector3(0, 0.5, 3)); // Core -> Cache
            const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
            const lines = new THREE.Line(lineGeo, lineMat);
            scene.add(lines);

            // Interaction
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            window.addEventListener('resize', onWindowResize, false);
            container.addEventListener('mousemove', onMouseMove, false);
            container.addEventListener('click', onClick, false);

            animate3D();
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function onMouseMove(event) {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / container.clientWidth) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / container.clientHeight) * 2 + 1;
        }

        let selectedObj = null;
        function onClick(event) {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(cpuGroup.children);
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                showInfo(obj.userData);
                highlightObj(obj);
                checkQuiz(obj.userData.name);
                playSound('click');
            }
        }

        function highlightObj(obj) {
            if(selectedObj) selectedObj.material.emissiveIntensity = 0.2;
            selectedObj = obj;
            selectedObj.material.emissiveIntensity = 0.8;
        }

        function showInfo(data) {
            const card = document.getElementById('info-card');
            document.getElementById('info-title').innerText = data.name;
            document.getElementById('info-desc').innerText = data.desc;
            document.getElementById('info-analogy').innerText = data.analogy;
            card.classList.remove('translate-x-full');
        }

        function closeInfo() {
            document.getElementById('info-card').classList.add('translate-x-full');
            if(selectedObj) selectedObj.material.emissiveIntensity = 0.2;
            selectedObj = null;
        }

        function toggleDataFlow() {
            isFlowing = !isFlowing;
            if(isFlowing) {
                // Create particles
                for(let i=0; i<20; i++) {
                    const pGeo = new THREE.SphereGeometry(0.1, 8, 8);
                    const pMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                    const p = new THREE.Mesh(pGeo, pMat);
                    // Simple path: Cache -> CU -> ALU
                    p.userData = { t: Math.random(), speed: 0.01 + Math.random()*0.01 };
                    scene.add(p);
                    particles.push(p);
                }
            } else {
                particles.forEach(p => scene.remove(p));
                particles = [];
            }
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            
            // Rotate whole CPU slightly
            cpuGroup.rotation.y += 0.002;

            // Animate particles
            if(isFlowing) {
                particles.forEach(p => {
                    p.userData.t += p.userData.speed;
                    if(p.userData.t > 1) p.userData.t = 0;
                    
                    // Path logic (Simplified Bezier or Linear)
                    // 0.0-0.3: Cache(0,1,3) -> Core(0,1,0)
                    // 0.3-0.6: Core(0,1,0) -> CU(-3,1,-3)
                    // 0.6-1.0: CU(-3,1,-3) -> ALU(3,1,-3)
                    const t = p.userData.t;
                    if(t < 0.3) {
                        const nt = t/0.3;
                        p.position.lerpVectors(new THREE.Vector3(0,1,3), new THREE.Vector3(0,1,0), nt);
                        p.material.color.setHex(0xbc13fe); // Purple
                    } else if (t < 0.6) {
                        const nt = (t-0.3)/0.3;
                        p.position.lerpVectors(new THREE.Vector3(0,1,0), new THREE.Vector3(-3,1,-3), nt);
                        p.material.color.setHex(0xff9e00); // Orange
                    } else {
                        const nt = (t-0.6)/0.4;
                        p.position.lerpVectors(new THREE.Vector3(-3,1,-3), new THREE.Vector3(3,1,-3), nt);
                        p.material.color.setHex(0x0aff0a); // Green
                    }
                });
            }

            renderer.render(scene, camera);
        }

        // Quiz Logic
        function checkQuiz(clickedName) {
            const feedback = document.getElementById('quiz-feedback');
            if(clickedName.includes('ALU')) {
                feedback.innerText = "âœ… å›ç­”æ­£ç¡®ï¼ALUè´Ÿè´£è¿ç®—";
                feedback.className = "px-3 py-1 rounded text-xs font-bold bg-green-500 text-black block animate-bounce";
                playSound('success');
            } else {
                feedback.innerText = "âŒ å†æƒ³æƒ³ï¼Œæ‰¾æ‰¾ç»¿è‰²çš„éƒ¨ä»¶";
                feedback.className = "px-3 py-1 rounded text-xs font-bold bg-red-500 text-white block";
            }
        }

        // --- PAGE 2: PIPELINE SIMULATOR ---
        let pipeMode = true; // true = pipeline, false = serial
        let pipeTimer = null;
        let instructions = []; // {id, stage: 0..4, color}
        let cycleCount = 0;
        let completedCount = 0;
        let nextInsId = 1;

        function setPipelineMode(isPipe) {
            pipeMode = isPipe;
            document.getElementById('btn-pipe').className = isPipe ? "px-3 py-1 rounded bg-cyan-600 text-white text-xs shadow-[0_0_10px_rgba(8,145,178,0.5)]" : "px-3 py-1 rounded bg-gray-700 text-xs hover:bg-gray-600 transition";
            document.getElementById('btn-no-pipe').className = !isPipe ? "px-3 py-1 rounded bg-cyan-600 text-white text-xs shadow-[0_0_10px_rgba(8,145,178,0.5)]" : "px-3 py-1 rounded bg-gray-700 text-xs hover:bg-gray-600 transition";
            pipeReset();
        }

        function pipeReset() {
            clearInterval(pipeTimer);
            pipeTimer = null;
            instructions = [];
            cycleCount = 0;
            completedCount = 0;
            nextInsId = 1;
            renderPipeline();
            updateStats();
        }

        function pipeStep() {
            cycleCount++;
            
            // Move existing instructions
            // Process backwards to avoid overwriting
            let stageOccupied = [false, false, false, false, false]; // 1-based stages 1..4
            
            // In serial mode, only one instruction exists at a time
            if (!pipeMode) {
                if (instructions.length > 0) {
                    const ins = instructions[0];
                    if (ins.stage < 4) ins.stage++;
                    else {
                        instructions.shift(); // Finish
                        completedCount++;
                    }
                } else {
                    // Spawn new
                    spawnInstruction();
                }
            } else {
                // Pipeline mode
                // 1. Move instructions that can move
                // Check for structural hazards (simplified: just move everyone forward if possible)
                // Actually in ideal pipeline, everyone moves 1 step per cycle
                
                // Remove finished
                if(instructions.length > 0 && instructions[0].stage === 4) {
                    instructions.shift();
                    completedCount++;
                }

                instructions.forEach(ins => ins.stage++);
                
                // Spawn new if IF stage is free (simplified: always spawn in ideal pipe)
                spawnInstruction();
            }

            renderPipeline();
            updateStats();
            playSound('click');
        }

        function spawnInstruction() {
            const colors = ['border-blue-500', 'border-purple-500', 'border-green-500'];
            instructions.push({
                id: nextInsId++,
                stage: 1, // 1=IF, 2=ID, 3=EX, 4=WB
                color: colors[nextInsId % 3]
            });
        }

        function pipePlay() {
            if(pipeTimer) return;
            pipeTimer = setInterval(pipeStep, 1000);
        }

        function renderPipeline() {
            const container = document.getElementById('pipeline-tracks');
            container.innerHTML = '';
            
            // Render each instruction as a row
            // To visualize pipeline, we usually show Time on X, but here we show Instructions on Y and Stages on X?
            // The request asked for "Tracks" for stages.
            // Let's do: Rows = Instructions. Columns = Stages.
            // Active stage is highlighted.
            
            // We only show active instructions
            instructions.forEach(ins => {
                const row = document.createElement('div');
                row.className = "grid grid-cols-6 gap-4 items-center animate-fade-in";
                
                // ID
                row.innerHTML += `<div class="col-span-1 text-center text-gray-400 font-mono">CMD_${ins.id}</div>`;
                
                // Stages
                for(let s=1; s<=4; s++) {
                    const isActive = (ins.stage === s);
                    let bgClass = "bg-gray-800/30";
                    let borderClass = "border-gray-700";
                    let glow = "";
                    
                    if(isActive) {
                        if(s===1) { bgClass="bg-blue-900/50"; borderClass="border-blue-400"; glow="shadow-[0_0_10px_rgba(59,130,246,0.5)]"; }
                        if(s===2) { bgClass="bg-green-900/50"; borderClass="border-green-400"; glow="shadow-[0_0_10px_rgba(34,197,94,0.5)]"; }
                        if(s===3) { bgClass="bg-yellow-900/50"; borderClass="border-yellow-400"; glow="shadow-[0_0_10px_rgba(234,179,8,0.5)]"; }
                        if(s===4) { bgClass="bg-red-900/50"; borderClass="border-red-400"; glow="shadow-[0_0_10px_rgba(239,68,68,0.5)]"; }
                    }

                    row.innerHTML += `
                        <div class="col-span-1 h-10 rounded border ${borderClass} ${bgClass} ${glow} flex items-center justify-center transition-all duration-300">
                            ${isActive ? '<div class="w-2 h-2 bg-white rounded-full animate-ping"></div>' : ''}
                        </div>
                    `;
                }
                
                // Status
                const status = ins.stage > 4 ? "Done" : "Running";
                row.innerHTML += `<div class="col-span-1 text-center text-xs text-gray-500">${status}</div>`;
                
                container.appendChild(row);
            });
        }

        function updateStats() {
            document.getElementById('stat-cycle').innerText = cycleCount;
            document.getElementById('stat-completed').innerText = completedCount;
            const ipc = cycleCount > 0 ? (completedCount / cycleCount).toFixed(2) : "0.00";
            document.getElementById('stat-ipc').innerText = ipc;
        }

        // --- PAGE 3: PERFORMANCE LAB ---
        let perfChart;
        
        function initPerf() {
            const ctx = document.getElementById('perfChart').getContext('2d');
            perfChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['æ¸¸æˆå¸§ç‡ (FPS)', 'è§£å‹é€Ÿåº¦ (MB/s)', 'è®¡ç®—è€—æ—¶ (s)'],
                    datasets: [{
                        label: 'å½“å‰æ€§èƒ½è¯„åˆ†',
                        data: [60, 100, 50],
                        backgroundColor: [
                            'rgba(6, 182, 212, 0.6)', // Cyan
                            'rgba(168, 85, 247, 0.6)', // Purple
                            'rgba(249, 115, 22, 0.6)'  // Orange
                        ],
                        borderColor: [
                            '#06b6d4', '#a855f7', '#f97316'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#aaa' } },
                        x: { grid: { display: false }, ticks: { color: '#aaa' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            updatePerfParams();
        }

        function updatePerfParams() {
            const freq = parseFloat(document.getElementById('input-freq').value);
            const cores = parseInt(document.getElementById('input-cores').value);
            const cache = parseInt(document.getElementById('input-cache').value);

            document.getElementById('val-freq').innerText = freq.toFixed(1);
            document.getElementById('val-cores').innerText = cores;
            document.getElementById('val-cache').innerText = cache;

            // Visuals
            // Cores
            const coreContainer = document.getElementById('core-visuals');
            coreContainer.innerHTML = '';
            for(let i=0; i<cores; i++) {
                const div = document.createElement('div');
                div.className = "flex-1 bg-purple-500 rounded shadow-[0_0_5px_#a855f7]";
                coreContainer.appendChild(div);
            }
            // Cache Bar
            const cacheBar = document.getElementById('cache-bar');
            cacheBar.style.width = (cache / 64 * 100) + '%';
            cacheBar.style.opacity = 0.5 + (cache/128);

            // Recalculate Chart Data (Simulation)
            // Game: High dependency on Freq, Medium on Cores
            const gameScore = (freq * 20) + (cores * 5) + (cache * 0.5);
            
            // Zip: High dependency on Cores and Cache
            const zipScore = (freq * 5) + (cores * 15) + (cache * 2);
            
            // Calc: Time (Lower is better). Base 100s. 
            // High freq reduces time significantly.
            const calcTime = 100 / (freq * 0.8 + cores * 0.2);

            if(perfChart) {
                perfChart.data.datasets[0].data = [gameScore, zipScore, calcTime];
                perfChart.update();
            }
        }

        function runPerfTest(type) {
            const loader = document.getElementById('perf-loading');
            loader.classList.remove('hidden');
            playSound('click');
            
            setTimeout(() => {
                loader.classList.add('hidden');
                playSound('success');
                // Flash effect on chart
                updatePerfParams();
            }, 1000);
        }

        // Initialize
        window.onload = () => {
            init3D();
            initPerf();
            // Start at page 1
            switchTab('structure');
        };

    </script>
</body>
</html>
